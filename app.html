<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinShield - Financial Literacy & Scam Awareness</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html, body {
            overflow-x: hidden; /* Prevents horizontal scrolling on the main page */
        }
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top, rgba(230, 0, 115, 0.05), transparent 40%), #F7F8FA;
        }
        /* Custom Colors & Gradients - WHITE & PINK THEME */
        .bg-primary { background-color: #E60073; }
        .text-primary { color: #E60073; }
        .border-primary { border-color: #E60073; }
        .ring-primary { --tw-ring-color: #E60073; }
        .bg-card { 
            background-color: #FFFFFF; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            background: linear-gradient(90deg, #E60073 0%, #FF4DA6 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(230, 0, 115, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(230, 0, 115, 0.4);
        }
        .btn-primary:disabled {
            background: #cccccc;
            box-shadow: none;
            cursor: not-allowed;
        }
        /* Bottom Nav active state */
        .nav-link.active {
            background-color: #F7F8FA; /* Match background */
        }
        .nav-link.active svg {
            color: #E60073;
        }
        .nav-link.active span {
            color: #E60073;
        }
        /* Hide scrollbar */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Page transition */
        .page {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Authentication Container -->
    <div id="auth-container" class="max-w-md mx-auto p-6">
        <!-- Login Page -->
        <div id="login-page" class="auth-page">
            <div class="text-center mb-8">
                <img src="https://finshieldtech.github.io/image/mascot%20original.png" alt="FinShield Mascot" class="w-48 h-48 mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/192x192/E60073/FFFFFF?text=FS';">
                <h2 class="text-3xl font-extrabold">Welcome Back!</h2>
                <p class="text-gray-500">Log in to manage your finances.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-600">Email Address</label>
                    <input type="email" id="login-email" class="w-full mt-1 bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-600">Password</label>
                    <input type="password" id="login-password" class="w-full mt-1 bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm hidden"></p>
                <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Log In</button>
            </form>
            <div class="text-center mt-4">
                <a href="#" onclick="showAuthPage('forgot-password-page')" class="text-sm text-primary font-semibold">Forgot Password?</a>
            </div>
            <div class="text-center mt-2">
                <p class="text-sm text-gray-500">Don't have an account? <a href="#" onclick="showAuthPage('register-page')" class="text-primary font-semibold">Register</a></p>
            </div>
        </div>

        <!-- Register Page -->
        <div id="register-page" class="auth-page hidden">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-extrabold">Create Account</h2>
                <p class="text-gray-500">Join FinShield and take control!</p>
            </div>
            <form id="register-form" class="space-y-4">
                <input type="text" id="register-name" placeholder="Full Name" class="w-full bg-gray-100 p-3 rounded-lg" required>
                <input type="email" id="register-email" placeholder="Email Address" class="w-full bg-gray-100 p-3 rounded-lg" required>
                <input type="password" id="register-password" placeholder="Password" class="w-full bg-gray-100 p-3 rounded-lg" required>
                <select id="register-country" class="w-full bg-gray-100 p-3 rounded-lg text-gray-500" required>
                    <option value="" disabled selected>Select your country</option>
                    <option value="Malaysia">Malaysia</option>
                    <option value="Indonesia">Indonesia</option>
                </select>
                <p id="register-error" class="text-red-500 text-sm hidden"></p>
                <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Register</button>
            </form>
            <div class="text-center mt-4">
                <p class="text-sm text-gray-500">Already have an account? <a href="#" onclick="showAuthPage('login-page')" class="text-primary font-semibold">Log In</a></p>
            </div>
        </div>

        <!-- Forgot Password Page -->
        <div id="forgot-password-page" class="auth-page hidden">
             <div class="text-center mb-8">
                <h2 class="text-3xl font-extrabold">Reset Password</h2>
                <p class="text-gray-500">Enter your email to get a reset link.</p>
            </div>
            <form id="forgot-password-form" class="space-y-4">
                <input type="email" id="forgot-email" placeholder="Email Address" class="w-full bg-gray-100 p-3 rounded-lg" required>
                <p id="forgot-error" class="text-red-500 text-sm hidden"></p>
                <div id="forgot-success" class="text-green-600 text-sm hidden bg-green-100 p-3 rounded-lg"></div>
                <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Send Reset Link</button>
            </form>
             <div class="text-center mt-4">
                <a href="#" onclick="showAuthPage('login-page')" class="text-sm text-primary font-semibold">Back to Login</a>
            </div>
        </div>

        <!-- Reset Password Page -->
        <div id="reset-password-page" class="auth-page hidden">
             <div class="text-center mb-8">
                <h2 class="text-3xl font-extrabold">Create New Password</h2>
                <p class="text-gray-500">Enter your new password below.</p>
            </div>
            <form id="reset-password-form" class="space-y-4">
                <input type="password" id="reset-password" placeholder="New Password" class="w-full bg-gray-100 p-3 rounded-lg" required>
                <input type="password" id="reset-password-confirm" placeholder="Confirm New Password" class="w-full bg-gray-100 p-3 rounded-lg" required>
                <p id="reset-error" class="text-red-500 text-sm hidden"></p>
                <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Reset Password</button>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="max-w-md mx-auto h-screen flex-col hidden">
        <!-- Header -->
        <header class="flex justify-between items-center p-6 flex-shrink-0">
            <div id="page-title" class="text-2xl font-bold">Wallet</div>
            <div class="flex items-center space-x-4">
                <!-- Back Button -->
                <a href="index.html" class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors" aria-label="Back to home">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
                <!-- Profile Button -->
                <button onclick="showPage('profile')" class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors" aria-label="View profile">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                </button>
            </div>
        </header>

        <!-- Main Content (Scrollable) -->
        <main class="flex-1 p-6 pt-0 overflow-y-auto">
            
            <!-- Home/Wallet Page -->
            <div id="home" class="page space-y-6">
                <div id="wallet-budget-warning" class="hidden"></div>
                <div class="bg-card p-6 rounded-2xl">
                    <p class="text-gray-500 text-sm">Total Balance</p>
                    <p id="current-balance" class="text-4xl font-extrabold">RM 0.00</p>
                    <!-- Points Display -->
                    <div class="mt-2 pt-2 border-t border-gray-100 flex items-center justify-center space-x-2">
                        <span class="text-yellow-500">‚≠ê</span>
                        <p id="home-points-display" class="font-bold text-gray-700">0 Points</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="showPage('income')" class="bg-card p-4 rounded-xl text-center hover:bg-gray-100 transition-colors">
                        üí∞
                        <span class="block font-semibold mt-1">Add Income</span>
                    </button>
                    <button onclick="showPage('addExpense')" class="bg-card p-4 rounded-xl text-center hover:bg-gray-100 transition-colors">
                        üí∏
                        <span class="block font-semibold mt-1">Add Expense</span>
                    </button>
                </div>
                <!-- Currency Converter Button -->
                <button onclick="showPage('currencyConverter')" class="bg-card p-4 rounded-xl text-center hover:bg-gray-100 transition-colors w-full flex items-center justify-center space-x-2">
                    <span class="text-2xl">üí±</span>
                    <span class="block font-semibold">Currency Converter</span>
                </button>
                <div>
                    <h3 class="text-xl font-bold mb-4">Recent Transactions</h3>
                    <div id="transaction-list" class="space-y-4">
                        <!-- Transactions will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Budgeting Page -->
            <div id="budgeting" class="page hidden space-y-6">
                <div id="budget-dashboard" class="hidden space-y-4">
                    <!-- Budget tracking dashboard will be rendered here -->
                </div>

                <div id="budget-setup">
                    <!-- Set Overall Limit -->
                     <div class="bg-card p-6 rounded-2xl text-center mb-6">
                         <h3 class="text-lg font-bold">Set a Spending Limit</h3>
                         <p class="text-gray-500 text-sm mt-1">This includes all your planned and unplanned expenses for the month.</p>
                          <div class="my-4">
                            <input type="number" id="spending-limit-input" placeholder="e.g., 1500" class="w-full text-center text-2xl font-bold bg-gray-100 p-2 rounded-lg border-gray-200 focus:ring-primary focus:border-primary">
                          </div>
                         <button onclick="setBudget()" class="btn-primary font-bold py-3 px-6 rounded-lg w-full">Set Limit & Start Tracking</button>
                     </div>

                    <!-- Category Budget View -->
                    <div id="category-budget-view" class="space-y-6">
                        <div id="category-budget-list" class="space-y-4">
                            <!-- Category budgets will be rendered here -->
                        </div>
                        <div class="bg-card p-6 rounded-2xl">
                            <h3 class="text-lg font-bold">Add New Category Budget</h3>
                            <form id="add-category-budget-form" class="mt-4 space-y-4">
                                <input type="text" id="category-budget-name" placeholder="Category Name (e.g., Food)" class="w-full bg-gray-100 p-3 rounded-lg border-gray-200 focus:ring-primary focus:border-primary" required>
                                <input type="number" id="category-budget-limit" placeholder="Monthly Limit" class="w-full bg-gray-100 p-3 rounded-lg border-gray-200 focus:ring-primary focus:border-primary" required>
                                <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Add Category</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saving Page -->
            <div id="saving" class="page hidden space-y-6">
                <div class="text-center mb-6">
                    <img src="https://finshieldtech.github.io/image/mascot%202.png" alt="Saving Mascot" class="w-48 h-48 mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/192x192/E60073/FFFFFF?text=FS';">
                    <h2 class="text-xl font-bold mt-4">Saving Goals</h2>
                    <p class="text-gray-600">Track your progress and achieve your dreams</p>
                </div>
                <div id="saving-goals-list" class="space-y-6">
                    <!-- Active goals will be rendered here -->
                </div>
                <div id="saving-empty-state" class="text-center hidden">
                    <h3 class="text-xl font-bold">Set a Goal, Save Smarter!</h3>
                    <p class="text-gray-500 mt-2 mb-4">You don't have any active savings goals yet.</p>
                </div>
                <button onclick="showPage('addSavingGoal')" class="btn-primary font-bold py-3 px-6 rounded-lg w-full">Create New Savings Goal</button>
            </div>

            <!-- NEW: Rewards Page -->
            <div id="rewards" class="page hidden space-y-6">
                <div class="bg-card p-6 rounded-2xl text-center">
                    <h3 class="text-xl font-bold">Your Rewards Points</h3>
                    <div class="flex items-center justify-center space-x-2 my-2">
                        <span class="text-3xl text-yellow-500">‚≠ê</span>
                        <p id="rewards-points-display" class="text-4xl font-extrabold text-primary">0</p>
                    </div>
                    <p class="text-gray-500 text-sm">Earn points by saving and staying on budget!</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Redeem Your Points</h3>
                    <div id="rewards-list" class="grid grid-cols-1 gap-4">
                        <!-- Rewards will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Investing Page -->
            <div id="investing" class="page hidden space-y-6">
                <div id="investment-content">
                    <!-- Investment content will be rendered here -->
                </div>
            </div>

            <!-- Data Defender Page -->
            <div id="dataDefender" class="page hidden">
                <div class="bg-card rounded-2xl p-6">
                    <p class="text-gray-500 mb-4">Paste a suspicious link below to check for red flags.</p>
                    <div class="flex space-x-2">
                        <input type="text" id="link-input" placeholder="https://your-suspicious-link.com" class="flex-grow min-w-0 bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none">
                        <button onclick="analyzeLink()" class="btn-primary font-bold py-3 px-6 rounded-lg">Check</button>
                    </div>
                    <div id="analysis-result" class="mt-6"></div>
                </div>
            </div>

            <!-- Income Page -->
            <div id="income" class="page hidden">
                <div class="bg-card rounded-2xl p-6">
                    <form id="income-form" class="space-y-6">
                        <div>
                            <label for="income-name" class="block text-sm font-medium text-gray-600 mb-2">Where did this income come from?</label>
                            <input type="text" id="income-name" placeholder="e.g., Salary, Freelance Project" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                        </div>
                        <div>
                            <label for="income-amount" class="block text-sm font-medium text-gray-600 mb-2">Amount (<span class="currency-label">RM</span>)</label>
                            <input type="number" id="income-amount" placeholder="e.g., 3000" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                        </div>
                        <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Add Income</button>
                    </form>
                </div>
            </div>

            <!-- Add Expense Page -->
            <div id="addExpense" class="page hidden">
                <div class="bg-card rounded-2xl p-6">
                    <form id="expense-form" class="space-y-6">
                        <div>
                            <label for="expense-name" class="block text-sm font-medium text-gray-600 mb-2">What is this expense for?</label>
                            <input type="text" id="expense-name" placeholder="e.g., Lunch, Movie tickets" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                        </div>
                        <div>
                            <label for="expense-amount" class="block text-sm font-medium text-gray-600 mb-2">Amount (<span class="currency-label">RM</span>)</label>
                            <input type="number" id="expense-amount" placeholder="e.g., 15.50" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                        </div>
                        <!-- Category Selector for Expenses -->
                        <div id="expense-category-selector-container">
                             <label for="expense-category-selector" class="block text-sm font-medium text-gray-600 mb-2">Assign to Budget Category (Optional)</label>
                             <select id="expense-category-selector" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none">
                                 <!-- Options will be populated by JS -->
                             </select>
                        </div>
                        <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Add Expense</button>
                    </form>
                </div>
            </div>
            
            <!-- Add Saving Goal Page -->
            <div id="addSavingGoal" class="page hidden">
                <div class="bg-card rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4">Create a New Savings Goal</h3>
                    <form id="saving-goal-form" class="space-y-6">
                        <div>
                            <label for="saving-goal-name" class="block text-sm font-medium text-gray-600 mb-2">What are you saving for?</label>
                            <input type="text" id="saving-goal-name" placeholder="e.g., New Phone" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                        </div>
                        <div>
                            <label for="saving-target-amount" class="block text-sm font-medium text-gray-600 mb-2">How much do you need? (<span class="currency-label">RM</span>)</label>
                            <input type="number" id="saving-target-amount" placeholder="e.g., 1500" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                        </div>
                        <div>
                            <label for="saving-monthly-contribution" class="block text-sm font-medium text-gray-600 mb-2">How much can you save per month? (<span class="currency-label">RM</span>)</label>
                            <input type="number" id="saving-monthly-contribution" placeholder="e.g., 250" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                        </div>
                        <div>
                            <label for="saving-payment-day" class="block text-sm font-medium text-gray-600 mb-2">Choose a payment day (1-28)</label>
                            <input type="number" id="saving-payment-day" min="1" max="28" placeholder="e.g., 25" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                        </div>
                        <div id="saving-estimate" class="text-center text-gray-600 bg-gray-100 p-3 rounded-lg hidden"></div>
                        <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg">Start Saving!</button>
                    </form>
                </div>
            </div>

            <!-- MODIFIED: Currency Converter Page -->
            <div id="currencyConverter" class="page hidden space-y-6">
                <div class="bg-card p-6 rounded-2xl">
                    <h3 class="text-xl font-bold mb-4">Quick Currency Converter</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="convert-amount" class="block text-sm font-medium text-gray-600 mb-2">Amount</label>
                            <input type="number" id="convert-amount" placeholder="e.g., 100" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none">
                        </div>
                        <div>
                            <label for="convert-from" class="block text-sm font-medium text-gray-600 mb-2">From Currency</label>
                            <select id="convert-from" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none">
                                <option value="MYR">Malaysian Ringgit (MYR)</option>
                                <option value="IDR">Indonesian Rupiah (IDR)</option>
                                <option value="USD">US Dollar (USD)</option>
                            </select>
                        </div>
                        <div id="conversion-results" class="space-y-2 pt-4 border-t border-gray-200">
                            <!-- Conversion results will be injected here by JS -->
                        </div>
                    </div>
                    <!-- MODIFICATION START -->
                    <div id="converter-initial-buttons" class="mt-6 grid grid-cols-2 gap-4">
                         <button onclick="prepareConvertedExpense()" class="btn-primary font-bold py-3 rounded-lg">Add as Expense</button>
                         <button onclick="showPage('home')" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-lg">Just Counting</button>
                    </div>
                    <div id="add-converted-expense-details" class="hidden mt-6 space-y-4 pt-4 border-t border-gray-200">
                        <h4 class="font-bold text-center">Add Expense Details</h4>
                        <div>
                            <label for="converted-expense-name" class="block text-sm font-medium text-gray-600 mb-2">Expense Name</label>
                            <input type="text" id="converted-expense-name" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none" required>
                        </div>
                        <div id="converted-expense-category-container">
                            <label for="converted-expense-category-selector" class="block text-sm font-medium text-gray-600 mb-2">Assign to Budget Category (Optional)</label>
                             <select id="converted-expense-category-selector" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none">
                                 <!-- Options will be populated by JS -->
                             </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="cancelAddConvertedExpense()" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-lg">Cancel</button>
                            <button onclick="confirmAddConvertedExpense()" class="btn-primary font-bold py-3 rounded-lg">Confirm Add</button>
                        </div>
                    </div>
                    <!-- MODIFICATION END -->
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile" class="page hidden space-y-6">
                <div class="bg-card p-6 rounded-2xl">
                    <h3 class="text-xl font-bold mb-4">Your Profile</h3>
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm text-gray-500">Name</p>
                            <p id="profile-name" class="font-semibold"></p>
                        </div>
                         <div>
                            <p class="text-sm text-gray-500">Email</p>
                            <p id="profile-email" class="font-semibold"></p>
                        </div>
                         <div>
                            <p class="text-sm text-gray-500">Country</p>
                            <p id="profile-country" class="font-semibold"></p>
                        </div>
                        <!-- Points display in profile -->
                        <div class="pt-2 border-t border-gray-100">
                            <p class="text-sm text-gray-500">Reward Points</p>
                            <p id="profile-points-display" class="font-bold text-lg text-primary">0 ‚≠ê</p>
                        </div>
                    </div>
                </div>
                <a href="financial_graphs.html" class="block text-center w-full btn-primary font-bold py-3 rounded-lg">Financial Graphs</a>
                <!-- Reset Data Button -->
                <button onclick="resetAllData()" class="w-full bg-red-100 text-red-600 font-bold py-3 rounded-lg hover:bg-red-200 transition-colors">Reset All Data</button>
                <button id="logout-button-profile" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-lg">Logout</button>
            </div>
        </main>

        <!-- Bottom Navigation (Sticky) -->
        <nav class="bg-card p-2 overflow-x-auto whitespace-nowrap hide-scrollbar flex-shrink-0">
            <div class="flex mx-auto justify-around">
                <a href="#" onclick="showPage('home')" data-title="Wallet" class="nav-link active flex flex-col items-center text-gray-500 p-3 rounded-lg flex-shrink-0 w-20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 mb-1"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path></svg>
                    <span class="text-xs font-medium">Wallet</span>
                </a>
                <a href="#" onclick="showPage('budgeting')" data-title="Budgeting" class="nav-link flex flex-col items-center text-gray-500 p-3 rounded-lg flex-shrink-0 w-20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 mb-1"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                    <span class="text-xs font-medium">Budget</span>
                </a>
                <a href="#" onclick="showPage('saving')" data-title="Saving" class="nav-link flex flex-col items-center text-gray-500 p-3 rounded-lg flex-shrink-0 w-20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 mb-1"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="M12 8v4l2 2"></path></svg>
                    <span class="text-xs font-medium">Saving</span>
                </a>
                <!-- New Rewards Nav Link -->
                <a href="#" onclick="showPage('rewards')" data-title="Rewards" class="nav-link flex flex-col items-center text-gray-500 p-3 rounded-lg flex-shrink-0 w-20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 mb-1"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>
                    <span class="text-xs font-medium">Rewards</span>
                </a>
                <a href="#" onclick="showPage('investing')" data-title="Investing" class="nav-link flex flex-col items-center text-gray-500 p-3 rounded-lg flex-shrink-0 w-20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 mb-1"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                    <span class="text-xs font-medium">Investing</span>
                </a>
                <a href="#" onclick="showPage('dataDefender')" data-title="Defender" class="nav-link flex flex-col items-center text-gray-500 p-3 rounded-lg flex-shrink-0 w-20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24" 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                    <span class="text-xs font-medium">Defender</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- NEW: Custom Modal Container -->
    <div id="custom-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="custom-modal" class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-sm text-center animate-fadeIn">
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div id="modal-input-container" class="hidden mb-4">
                <input type="text" id="modal-input" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none">
            </div>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <!-- Buttons will be injected here by JS -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- DATA & STATE MANAGEMENT ---
        let transactions = [];
        let savingsGoals = [];
        let budget = null;
        let categoryBudgets = []; 
        let currentUser = null;
        let currencySymbol = 'RM';
        let exchangeRatesCache = null; 
        let userPoints = 0;
        let lastBudgetPointsAwarded = null; // Stores "YYYY-MM"

        // MODIFICATION: Variable to hold amount while user fills details
        let tempConvertedAmount = 0; 
        const pageTitleEl = document.getElementById('page-title');
        const navLinks = document.querySelectorAll('.nav-link');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');

        // --- MOCK REWARDS DATA ---
        const rewards = [
            { id: 1, partner: "Starbucks", name: "Free Coffee", pointsCost: 200, img: "https://placehold.co/100x100/036635/FFFFFF?text=Coffee" },
            { id: 2, partner: "McDonald's", name: "Free McFlurry", pointsCost: 150, img: "https://placehold.co/100x100/FFC72C/000000?text=McD" },
            { id: 3, partner: "Amazon", name: "RM 5 Voucher", pointsCost: 500, img: "https://placehold.co/100x100/000000/FFFFFF?text=Amazon" },
            { id: 4, partner: "Uniqlo", name: "10% Off Coupon", pointsCost: 800, img: "https://placehold.co/100x100/FF0000/FFFFFF?text=Uniqlo" }
        ];

        function loadData() {
            if (!currentUser) return;
            const email = currentUser.email;
            transactions = JSON.parse(localStorage.getItem(`finshieldTransactions_${email}`)) || [];
            savingsGoals = JSON.parse(localStorage.getItem(`finshieldSavingsGoals_${email}`)) || [];
            budget = JSON.parse(localStorage.getItem(`finshieldBudget_${email}`)) || null;
            categoryBudgets = JSON.parse(localStorage.getItem(`finshieldCategoryBudgets_${email}`)) || []; 
            userPoints = parseInt(localStorage.getItem(`finshieldPoints_${email}`), 10) || 0;
            lastBudgetPointsAwarded = localStorage.getItem(`finshieldLastAward_${email}`) || null;
        }

        function saveData() {
            if (!currentUser) return;
            const email = currentUser.email;
            localStorage.setItem(`finshieldTransactions_${email}`, JSON.stringify(transactions));
            localStorage.setItem(`finshieldSavingsGoals_${email}`, JSON.stringify(savingsGoals));
            localStorage.setItem(`finshieldBudget_${email}`, JSON.stringify(budget));
            localStorage.setItem(`finshieldCategoryBudgets_${email}`, JSON.stringify(categoryBudgets)); 
            localStorage.setItem(`finshieldPoints_${email}`, userPoints);
            localStorage.setItem(`finshieldLastAward_${email}`, lastBudgetPointsAwarded);
        }

        // --- NEW: CUSTOM MODAL LOGIC ---
        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalMessage = document.getElementById('modal-message');
        const modalInputContainer = document.getElementById('modal-input-container');
        const modalInput = document.getElementById('modal-input');
        const modalButtons = document.getElementById('modal-buttons');

        function hideModal() {
            modalOverlay.classList.add('hidden');
        }

        function showCustomAlert(message, onOk) {
            modalMessage.textContent = message;
            modalInputContainer.classList.add('hidden');
            modalButtons.innerHTML = `<button class="btn-primary font-bold py-2 px-6 rounded-lg w-full">OK</button>`;
            modalButtons.querySelector('button').onclick = () => {
                hideModal();
                if (onOk) onOk();
            };
            modalOverlay.classList.remove('hidden');
        }

        function showCustomConfirm(message, onConfirm) {
            modalMessage.textContent = message;
            modalInputContainer.classList.add('hidden');
            modalButtons.innerHTML = `
                <button class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button class="btn-primary font-bold py-2 px-6 rounded-lg w-full">Confirm</button>
            `;
            modalButtons.children[0].onclick = hideModal; // Cancel button
            modalButtons.children[1].onclick = () => { // Confirm button
                hideModal();
                onConfirm();
            };
            modalOverlay.classList.remove('hidden');
        }

        // --- AUTHENTICATION ---
        function showAuthPage(pageId) {
            document.querySelectorAll('.auth-page').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }
        window.showAuthPage = showAuthPage;

        function checkLoginStatus() {
            const userEmail = localStorage.getItem('finshieldCurrentUser');
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('resetToken');

            if (resetToken) {
                const tokenData = JSON.parse(localStorage.getItem(`finshieldResetToken`));
                if (tokenData && tokenData.token === resetToken && Date.now() < tokenData.expiry) {
                    showAuthPage('reset-password-page');
                } else {
                    showCustomAlert("Password reset link is invalid or has expired.", () => {
                        window.location.search = ''; // Clear the token from URL
                    });
                }
                return;
            }

            if (userEmail) {
                currentUser = JSON.parse(localStorage.getItem(`finshieldUser_${userEmail}`));
                if (currentUser) {
                    currencySymbol = currentUser.country === 'Indonesia' ? 'Rp' : 'RM';
                    document.querySelectorAll('.currency-label').forEach(el => el.textContent = currencySymbol);
                    authContainer.classList.add('hidden');
                    appContainer.classList.add('flex');
                    appContainer.classList.remove('hidden');
                    loadData();
                    updateAll();
                    return;
                }
            }
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            appContainer.classList.remove('flex');
        }

        function logout() {
            localStorage.removeItem('finshieldCurrentUser');
            currentUser = null;
            location.reload();
        }
        document.getElementById('logout-button-profile').addEventListener('click', logout);


        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const user = JSON.parse(localStorage.getItem(`finshieldUser_${email}`));
            const errorEl = document.getElementById('login-error');

            if (user && user.password === password) {
                localStorage.setItem('finshieldCurrentUser', email);
                checkLoginStatus();
            } else {
                errorEl.textContent = 'Invalid email or password.';
                errorEl.classList.remove('hidden');
            }
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const country = document.getElementById('register-country').value;
            const errorEl = document.getElementById('register-error');

            if (!country) {
                errorEl.textContent = 'Please select a country.';
                errorEl.classList.remove('hidden');
                return;
            }

            if (localStorage.getItem(`finshieldUser_${email}`)) {
                errorEl.textContent = 'An account with this email already exists.';
                errorEl.classList.remove('hidden');
                return;
            }
            
            const newUser = { name, email, password, country };
            localStorage.setItem(`finshieldUser_${email}`, JSON.stringify(newUser));
            localStorage.setItem('finshieldCurrentUser', email);
            checkLoginStatus();
        });
        
        document.getElementById('forgot-password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            const successEl = document.getElementById('forgot-success');
            const errorEl = document.getElementById('forgot-error');
            
            if (localStorage.getItem(`finshieldUser_${email}`)) {
                 errorEl.classList.add('hidden');
                 const token = `reset_${email}_${Date.now()}`;
                 const expiry = Date.now() + 15 * 60 * 1000; // 15 minutes
                 localStorage.setItem('finshieldResetToken', JSON.stringify({ email, token, expiry }));

                 const resetLink = `${window.location.origin}${window.location.pathname}?resetToken=${token}`;
                 
                 successEl.innerHTML = `An email simulation from <strong>finshieldtech.jp@gmail.com</strong>:<br>Click the button below to reset your password.<br><br>
                    <a href="${resetLink}" class="btn-primary inline-block font-bold py-2 px-4 rounded-lg">Reset Password</a>`;
                 successEl.classList.remove('hidden');
            } else {
                 successEl.classList.add('hidden');
                 errorEl.textContent = 'No account found with that email.';
                 errorEl.classList.remove('hidden');
            }
        });

        document.getElementById('reset-password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('reset-password').value;
            const confirmPassword = document.getElementById('reset-password-confirm').value;
            const errorEl = document.getElementById('reset-error');
            const tokenData = JSON.parse(localStorage.getItem('finshieldResetToken'));

            if (newPassword !== confirmPassword) {
                errorEl.textContent = "Passwords do not match.";
                errorEl.classList.remove('hidden');
                return;
            }

            const user = JSON.parse(localStorage.getItem(`finshieldUser_${tokenData.email}`));
            user.password = newPassword;
            localStorage.setItem(`finshieldUser_${tokenData.email}`, JSON.stringify(user));
            
            localStorage.removeItem('finshieldResetToken');
            localStorage.setItem('finshieldCurrentUser', user.email);
            window.location.search = ''; // This will reload the page and log the user in
        });


        // --- PAGE NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            const newPage = document.getElementById(pageId);
            newPage.classList.remove('hidden');
            
            const pageTitles = {
                home: 'Wallet', budgeting: 'Budgeting', saving: 'Saving', investing: 'Investing',
                dataDefender: 'Defender', income: 'Add Income', addExpense: 'Add Expense',
                addSavingGoal: 'New Saving Goal', profile: 'Profile', currencyConverter: 'Converter',
                rewards: 'Rewards'
            };
            pageTitleEl.textContent = pageTitles[pageId] || 'FinShield';

            navLinks.forEach(link => {
                link.classList.toggle('active', link.getAttribute('onclick').includes(`'${pageId}'`));
            });
            
            if (pageId === 'saving') renderSavingGoals();
            if (pageId === 'budgeting') renderBudgetPage();
            if (pageId === 'investing') updateInvestingPage();
            if (pageId === 'profile') renderProfilePage();
            if (pageId === 'addExpense') renderExpenseCategorySelector();
            if (pageId === 'rewards') renderRewardsPage();
            if (pageId === 'currencyConverter') cancelAddConvertedExpense();
        }
        window.showPage = showPage;
        
        // --- PROFILE PAGE ---
        function renderProfilePage() {
            if (currentUser) {
                document.getElementById('profile-name').textContent = currentUser.name;
                document.getElementById('profile-email').textContent = currentUser.email;
                document.getElementById('profile-country').textContent = currentUser.country;
                document.getElementById('profile-points-display').textContent = `${userPoints} ‚≠ê`;
            }
        }

        // --- RENDER & UPDATE FUNCTIONS ---
        function formatCurrency(amount, currencyCode = currencySymbol) {
            if (currencyCode === 'IDR' || (currencyCode === 'Rp')) {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            }
             if (currencyCode === 'USD') {
                 return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
            }
            // Default to MYR
            return `RM ${Number(amount).toFixed(2)}`;
        }

        function renderTransactions() {
            const transactionList = document.getElementById('transaction-list');
            if (transactions.length === 0) {
                transactionList.innerHTML = `<p class="text-gray-500 text-center">No transactions yet.</p>`;
                return;
            }
            transactionList.innerHTML = transactions.slice().reverse().map(tx => {
                const isIncome = tx.type === 'income';
                const amountColor = isIncome ? 'text-green-500' : tx.type === 'saving' ? 'text-blue-500' : 'text-red-500';
                const sign = isIncome ? '+' : '-';
                const icon = isIncome ? 'üíº' : (tx.type === 'saving' ? 'üéØ' : 'üí∏');
                return `
                <div class="flex items-center bg-card p-4 rounded-xl">
                    <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-xl mr-4">${icon}</div>
                    <div class="flex-1">
                        <p class="font-bold">${tx.name}</p>
                        <p class="text-sm text-gray-500">${new Date(tx.date).toLocaleDateString()}</p>
                    </div>
                    <p class="font-bold ${amountColor}">${sign}${formatCurrency(Math.abs(tx.amount))}</p>
                </div>`;
            }).join('');
        }

        function updateBalance() {
            const totalBalance = transactions.reduce((sum, tx) => sum + tx.amount, 0);
            document.getElementById('current-balance').textContent = formatCurrency(totalBalance);
            return totalBalance;
        }
        
        // --- FORM SUBMISSIONS ---
        document.getElementById('income-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('income-name').value;
            const amount = parseFloat(document.getElementById('income-amount').value);
            if (name && amount > 0) {
                transactions.push({ name: name, amount: amount, type: 'income', date: new Date() });
                saveData();
                updateAll();
                e.target.reset(); 
                showPage('home'); 
            }
        });

        document.getElementById('expense-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('expense-name').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const categoryId = document.getElementById('expense-category-selector').value; 
            if (name && amount > 0) {
                const newExpense = { 
                    name: name, 
                    amount: -amount, 
                    type: 'expense', 
                    date: new Date() 
                };
                if (categoryId && categoryId !== 'none') {
                    newExpense.categoryId = parseInt(categoryId); 
                }
                transactions.push(newExpense);
                saveData();
                updateAll();
                e.target.reset();
                showPage('home');
            }
        });
        
        document.getElementById('saving-goal-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const newGoal = {
                id: Date.now(),
                name: document.getElementById('saving-goal-name').value,
                targetAmount: parseFloat(document.getElementById('saving-target-amount').value),
                monthlyContribution: parseFloat(document.getElementById('saving-monthly-contribution').value),
                paymentDay: parseInt(document.getElementById('saving-payment-day').value),
                savedAmount: 0,
            };
            savingsGoals.push(newGoal);
            saveData();
            updateAll();
            e.target.reset();
            showPage('saving');
        });

        // --- SAVING GOAL LOGIC ---
        function renderSavingGoals() {
            const listDiv = document.getElementById('saving-goals-list');
            const emptyDiv = document.getElementById('saving-empty-state');

            if (savingsGoals.length === 0) {
                listDiv.innerHTML = '';
                emptyDiv.classList.remove('hidden');
                return;
            }
            
            emptyDiv.classList.add('hidden');
            listDiv.innerHTML = savingsGoals.map(goal => {
                const { id, name, targetAmount, savedAmount, monthlyContribution, paymentDay } = goal;
                const progress = (savedAmount / targetAmount) * 100;
                const amountLeft = targetAmount - savedAmount;
                const monthsLeft = (monthlyContribution > 0) ? Math.ceil(amountLeft / monthlyContribution) : Infinity;
                let reminder = '';
                if (new Date().getDate() === paymentDay) {
                    reminder = `<div class="p-3 mb-4 bg-yellow-100 text-yellow-700 rounded-lg text-center font-semibold">üîî Today is your monthly savings day for "${name}"!</div>`;
                }
                return `
                    <div class="space-y-4 mb-6">
                        ${reminder}
                        <div class="bg-card p-6 rounded-2xl">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold">${name}</h3>
                                <span class="font-bold text-primary">${progress.toFixed(0)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-primary h-2.5 rounded-full" style="width: ${progress}%"></div></div>
                            <div class="flex justify-between text-sm mt-2">
                                <span>Saved: ${formatCurrency(savedAmount)}</span>
                                <span>Target: ${formatCurrency(targetAmount)}</span>
                            </div>
                        </div>
                        <div class="bg-card p-6 rounded-2xl">
                            <h4 class="font-bold mb-2">Your Progress</h4>
                            <p class="text-gray-500 text-sm">With your current plan, you'll reach your goal in about:</p>
                            <p class="text-2xl font-bold text-primary mt-1">${monthsLeft === Infinity ? 'N/A' : `${monthsLeft} months`}</p>
                            <button onclick="makeSavingsPayment(${id}, ${monthlyContribution})" class="btn-primary font-bold py-3 w-full rounded-lg mt-4">Save ${formatCurrency(monthlyContribution)} Now</button>
                        </div>
                        <div class="text-center">
                            <button onclick="promptCancelSavingGoal(${id})" class="text-sm text-red-500 font-semibold">Cancel this Goal</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        window.makeSavingsPayment = makeSavingsPayment;
        
        function makeSavingsPayment(goalId, amount) {
            if (updateBalance() < amount) {
                showCustomAlert("Not enough balance to make this savings payment.");
                return;
            }
            const goal = savingsGoals.find(g => g.id === goalId);
            if (goal) {
                goal.savedAmount += amount;
                transactions.push({ name: `Saving for ${goal.name}`, amount: -amount, type: 'saving', date: new Date() });
                
                // Award points for saving
                userPoints += 10;
                showCustomAlert(`+10 points for saving towards your goal!`);

                saveData();
                updateAll();
                renderSavingGoals();
            }
        }

        function promptCancelSavingGoal(goalId) {
            showCustomConfirm("Are you sure you want to cancel this savings goal?", () => {
                savingsGoals = savingsGoals.filter(g => g.id !== goalId);
                saveData();
                renderSavingGoals();
            });
        }
        window.promptCancelSavingGoal = promptCancelSavingGoal;
        
        function calculateSavingEstimate() {
             const target = parseFloat(document.getElementById('saving-target-amount').value) || 0;
             const contribution = parseFloat(document.getElementById('saving-monthly-contribution').value) || 0;
             const estimateDiv = document.getElementById('saving-estimate');
             if (target > 0 && contribution > 0) {
                const months = Math.ceil(target / contribution);
                estimateDiv.textContent = `Estimated time to reach goal: ${months} months.`;
                estimateDiv.classList.remove('hidden');
             } else {
                estimateDiv.classList.add('hidden');
             }
        }
        document.getElementById('addSavingGoal').addEventListener('input', calculateSavingEstimate);

        // --- BUDGETING PAGE LOGIC ---
        function renderBudgetPage() {
            renderOverallBudget();
            renderCategoryBudgets();
        }

        function renderOverallBudget() {
            const dashboard = document.getElementById('budget-dashboard');
            const setup = document.getElementById('budget-setup');
            if (budget && budget.limit > 0) {
                setup.classList.add('hidden');
                dashboard.classList.remove('hidden');
                renderBudgetDashboard();
            } else {
                dashboard.classList.add('hidden');
                setup.classList.remove('hidden');
            }
        }

        function renderBudgetDashboard() {
            const totalExpenses = transactions
                .filter(tx => tx.type === 'expense' && new Date(tx.date).getMonth() === new Date().getMonth())
                .reduce((sum, tx) => sum + Math.abs(tx.amount), 0);
            
            const progress = (budget.limit > 0) ? (totalExpenses / budget.limit) * 100 : 0;
            const isOverLimit = progress > 100;
            
            let warningHTML = '';
            if (isOverLimit) {
                warningHTML = `<div class="p-3 bg-red-100 text-red-700 rounded-lg text-center font-semibold">
                    üö® Warning! You've exceeded your spending limit!
                </div>`;
            }
            document.getElementById('wallet-budget-warning').innerHTML = warningHTML;
            document.getElementById('wallet-budget-warning').classList.toggle('hidden', !isOverLimit);

            document.getElementById('budget-dashboard').innerHTML = `
                ${warningHTML}
                <div class="bg-card p-6 rounded-2xl">
                    <h3 class="text-xl font-bold">Monthly Spending</h3>
                    <div class="w-full bg-gray-200 rounded-full h-4 mt-4">
                        <div class="bg-${isOverLimit ? 'red' : 'primary'}-500 h-4 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                    </div>
                    <div class="flex justify-between text-sm mt-2">
                        <span>Spent: ${formatCurrency(totalExpenses)}</span>
                        <span>Limit: ${formatCurrency(budget.limit)}</span>
                    </div>
                </div>
                <button onclick="resetBudget()" class="text-sm text-gray-500 text-center w-full">Reset Budget</button>
            `;
        }
        window.resetBudget = resetBudget;
        
        function resetBudget() {
            budget = null;
            saveData();
            renderOverallBudget();
            document.getElementById('wallet-budget-warning').classList.add('hidden');
        }

        function setBudget() {
            const limit = parseFloat(document.getElementById('spending-limit-input').value);
            if (limit > 0) {
                budget = { limit: limit };
                saveData();
                renderOverallBudget();
            }
        }
        window.setBudget = setBudget;

        function renderCategoryBudgets() {
            const listEl = document.getElementById('category-budget-list');
            if (categoryBudgets.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center bg-card p-6 rounded-2xl">No category budgets set up yet. Add one below to start tracking!</p>`;
                return;
            }

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            listEl.innerHTML = categoryBudgets.map(cat => {
                const spentThisMonth = transactions
                    .filter(tx => {
                        const txDate = new Date(tx.date);
                        return tx.type === 'expense' &&
                               tx.categoryId === cat.id &&
                               txDate.getMonth() === currentMonth &&
                               txDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, tx) => sum + Math.abs(tx.amount), 0);
                
                const progress = cat.limit > 0 ? (spentThisMonth / cat.limit) * 100 : 0;
                const isOverLimit = progress > 100;
                const progressBarColor = isOverLimit ? 'bg-red-500' : 'bg-primary';

                let alertHTML = '';
                if (isOverLimit) {
                    alertHTML = `<div class="mt-3 p-2 bg-red-100 text-red-700 text-sm rounded-lg font-semibold text-center">üö® Budget Exceeded!</div>`;
                }

                return `
                <div class="bg-card p-6 rounded-2xl">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-xl font-bold">${cat.name}</h4>
                            <p class="text-sm text-gray-500">Limit: ${formatCurrency(cat.limit)}</p>
                        </div>
                        <button onclick="deleteCategoryBudget(${cat.id})" class="text-gray-400 hover:text-red-500">&times;</button>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-4 my-3">
                        <div class="${progressBarColor} h-4 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                    </div>
                    <div class="flex justify-between text-sm font-medium">
                        <span class="${isOverLimit ? 'text-red-500' : ''}">Spent: ${formatCurrency(spentThisMonth)}</span>
                        <span class="text-gray-600">Left: ${formatCurrency(cat.limit - spentThisMonth)}</span>
                    </div>
                    ${alertHTML}
                    <form onsubmit="addQuickExpense(event, ${cat.id})" class="mt-4 flex space-x-2">
                        <input type="number" placeholder="Add expense amount" class="flex-grow min-w-0 bg-gray-100 border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-primary focus:outline-none" required>
                        <button type="submit" class="btn-primary font-bold py-2 px-4 rounded-lg">Add</button>
                    </form>
                </div>
                `;
            }).join('');
        }

        document.getElementById('add-category-budget-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('category-budget-name').value;
            const limit = parseFloat(document.getElementById('category-budget-limit').value);

            if (name && limit > 0) {
                categoryBudgets.push({ id: Date.now(), name, limit });
                saveData();
                renderCategoryBudgets();
                e.target.reset();
            }
        });

        function addQuickExpense(event, categoryId) {
            event.preventDefault();
            const amount = parseFloat(event.target.querySelector('input').value);
            const category = categoryBudgets.find(c => c.id === categoryId);

            if (amount > 0 && category) {
                transactions.push({
                    name: `Expense for ${category.name}`,
                    amount: -amount,
                    type: 'expense',
                    date: new Date(),
                    categoryId: categoryId
                });
                saveData();
                updateAll();
                event.target.reset();
            }
        }
        window.addQuickExpense = addQuickExpense;

        function deleteCategoryBudget(categoryId) {
            showCustomConfirm('Are you sure you want to delete this budget category?', () => {
                categoryBudgets = categoryBudgets.filter(cat => cat.id !== categoryId);
                transactions.forEach(tx => {
                    if (tx.categoryId === categoryId) {
                        delete tx.categoryId;
                    }
                });
                saveData();
                renderCategoryBudgets();
            });
        }
        window.deleteCategoryBudget = deleteCategoryBudget;

        function renderExpenseCategorySelector() {
            const selector = document.getElementById('expense-category-selector');
            if (categoryBudgets.length > 0) {
                selector.innerHTML = `<option value="none">Uncategorized</option>` + categoryBudgets.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
                document.getElementById('expense-category-selector-container').classList.remove('hidden');
            } else {
                document.getElementById('expense-category-selector-container').classList.add('hidden');
            }
        }

        // --- REWARDS LOGIC ---
        function renderUserPoints() {
            document.getElementById('home-points-display').textContent = `${userPoints} Points`;
            document.getElementById('rewards-points-display').textContent = userPoints;
            document.getElementById('profile-points-display').textContent = `${userPoints} ‚≠ê`;
        }

        function renderRewardsPage() {
            renderUserPoints();
            const listEl = document.getElementById('rewards-list');
            listEl.innerHTML = rewards.map(reward => {
                const canAfford = userPoints >= reward.pointsCost;
                return `
                <div class="bg-card p-4 rounded-xl flex items-center space-x-4">
                    <img src="${reward.img}" alt="${reward.name}" class="w-16 h-16 rounded-lg object-cover" onerror="this.onerror=null;this.src='https://placehold.co/100x100/cccccc/FFFFFF?text=Img';">
                    <div class="flex-1">
                        <p class="font-bold">${reward.name}</p>
                        <p class="text-sm text-gray-500">${reward.partner}</p>
                        <p class="text-sm font-semibold text-primary">${reward.pointsCost} Points</p>
                    </div>
                    <button onclick="redeemReward(${reward.id})" class="btn-primary font-bold py-2 px-4 rounded-lg text-sm" ${!canAfford ? 'disabled' : ''}>
                        Redeem
                    </button>
                </div>
                `;
            }).join('');
        }
        
        function redeemReward(rewardId) {
            const reward = rewards.find(r => r.id === rewardId);
            if (reward && userPoints >= reward.pointsCost) {
                showCustomConfirm(`Redeem "${reward.name}" for ${reward.pointsCost} points?`, () => {
                    userPoints -= reward.pointsCost;
                    saveData();
                    renderRewardsPage();
                    showCustomAlert(`Success! Your voucher for "${reward.name}" will be sent to your email.`);
                });
            }
        }
        window.redeemReward = redeemReward;

        function checkAndAwardPoints() {
            const now = new Date();
            const currentMonthMarker = `${now.getFullYear()}-${now.getMonth()}`;
            
            // Only run this check once per month
            if (lastBudgetPointsAwarded === currentMonthMarker) {
                return;
            }

            // Check the PREVIOUS month's performance
            const lastMonth = new Date(now.setMonth(now.getMonth() - 1));
            const lastMonthYear = lastMonth.getFullYear();
            const lastMonthMonth = lastMonth.getMonth();

            if (budget && budget.limit > 0) {
                const expensesLastMonth = transactions
                    .filter(tx => {
                        const txDate = new Date(tx.date);
                        return tx.type === 'expense' &&
                               txDate.getFullYear() === lastMonthYear &&
                               txDate.getMonth() === lastMonthMonth;
                    })
                    .reduce((sum, tx) => sum + Math.abs(tx.amount), 0);
                
                if (expensesLastMonth <= budget.limit) {
                    userPoints += 100;
                    showCustomAlert(`Congratulations! You stayed within your budget last month. You've earned 100 points!`);
                }
            }
            
            // Mark this month as checked
            lastBudgetPointsAwarded = currentMonthMarker;
            saveData();
        }

        // --- CURRENCY CONVERTER LOGIC ---
        async function fetchExchangeRates(baseCurrency) {
            const resultsDiv = document.getElementById('conversion-results');
            resultsDiv.innerHTML = `<p class="text-center text-gray-500 animate-pulse">Fetching latest rates...</p>`;
            if (exchangeRatesCache && exchangeRatesCache.base_code === baseCurrency) return true;
            try {
                const response = await fetch(`https://open.er-api.com/v6/latest/${baseCurrency}`);
                if (!response.ok) throw new Error('Network response failed.');
                const data = await response.json();
                if (data.result === 'success') {
                    exchangeRatesCache = data; 
                    return true;
                } else {
                    throw new Error('API returned an error.');
                }
            } catch (error) {
                console.error("Failed to fetch exchange rates:", error);
                resultsDiv.innerHTML = `<p class="text-center text-red-500">Could not fetch live rates. Please try again later.</p>`;
                exchangeRatesCache = null; 
                return false;
            }
        }

        async function calculateConversion() {
            const amount = parseFloat(document.getElementById('convert-amount').value) || 0;
            const fromCurrency = document.getElementById('convert-from').value;
            const resultsDiv = document.getElementById('conversion-results');
            if (amount === 0) {
                resultsDiv.innerHTML = '<p class="text-center text-gray-500">Enter an amount to see conversions.</p>';
                return;
            }
            const success = await fetchExchangeRates(fromCurrency);
            if (!success) return; 
            let resultsHTML = '';
            const rates = exchangeRatesCache.rates;
            const currenciesToConvertTo = ['MYR', 'IDR', 'USD'].filter(c => c !== fromCurrency);
            currenciesToConvertTo.forEach(toCurrency => {
                const rate = rates[toCurrency];
                if (rate) {
                    const convertedAmount = amount * rate;
                    resultsHTML += `
                        <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                            <span class="font-semibold text-gray-700">${toCurrency}</span>
                            <span class="font-bold text-lg text-primary">${formatCurrency(convertedAmount, toCurrency)}</span>
                        </div>`;
                }
            });
            resultsDiv.innerHTML = resultsHTML;
        }
        
        document.getElementById('convert-amount').addEventListener('input', calculateConversion);
        document.getElementById('convert-from').addEventListener('change', calculateConversion);

        // MODIFICATION START: New functions for handling converted expenses
        function renderConvertedExpenseCategorySelector() {
            const selector = document.getElementById('converted-expense-category-selector');
            const container = document.getElementById('converted-expense-category-container');
            if (categoryBudgets.length > 0) {
                selector.innerHTML = `<option value="none">Uncategorized</option>` + categoryBudgets.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        async function prepareConvertedExpense() {
            const amount = parseFloat(document.getElementById('convert-amount').value) || 0;
            const fromCurrency = document.getElementById('convert-from').value;
            if (amount <= 0) {
                showCustomAlert("Please enter a valid amount to add as an expense.");
                return;
            }
            if (!exchangeRatesCache || exchangeRatesCache.base_code !== fromCurrency) {
                const success = await fetchExchangeRates(fromCurrency);
                if (!success) {
                    showCustomAlert("Could not fetch exchange rates. Please try again.");
                    return;
                }
            }
            const homeCurrency = currentUser.country === 'Indonesia' ? 'IDR' : 'MYR';
            const rate = exchangeRatesCache.rates[homeCurrency];
            tempConvertedAmount = amount * rate;
            
            document.getElementById('converted-expense-name').value = `${fromCurrency} Purchase`;
            renderConvertedExpenseCategorySelector();

            document.getElementById('converter-initial-buttons').classList.add('hidden');
            document.getElementById('add-converted-expense-details').classList.remove('hidden');
        }
        window.prepareConvertedExpense = prepareConvertedExpense;

        function confirmAddConvertedExpense() {
            const expenseName = document.getElementById('converted-expense-name').value;
            const categoryId = document.getElementById('converted-expense-category-selector').value;
            if (!expenseName) {
                showCustomAlert("Please enter a name for the expense.");
                return;
            }

            const newExpense = {
                name: expenseName,
                amount: -tempConvertedAmount,
                type: 'expense',
                date: new Date()
            };
            if (categoryId && categoryId !== 'none') {
                newExpense.categoryId = parseInt(categoryId);
            }
            transactions.push(newExpense);
            saveData();
            updateAll();
            showPage('home');
        }
        window.confirmAddConvertedExpense = confirmAddConvertedExpense;

        function cancelAddConvertedExpense() {
            document.getElementById('converter-initial-buttons').classList.remove('hidden');
            document.getElementById('add-converted-expense-details').classList.add('hidden');
            tempConvertedAmount = 0;
        }
        window.cancelAddConvertedExpense = cancelAddConvertedExpense;
        // MODIFICATION END

        // --- RESET DATA LOGIC ---
        function resetAllData() {
            showCustomConfirm("Are you sure you want to delete ALL your financial data? This action cannot be undone.", () => {
                transactions = [];
                savingsGoals = [];
                budget = null;
                categoryBudgets = [];
                userPoints = 0;
                lastBudgetPointsAwarded = null;
                saveData();
                updateAll();
                showCustomAlert("All your data has been reset.");
            });
        }
        window.resetAllData = resetAllData;


        // --- INVESTING PAGE LOGIC ---
        function updateInvestingPage() {
            const contentDiv = document.getElementById('investment-content');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const monthlyIncome = transactions
                .filter(tx => tx.type === 'income' && new Date(tx.date).getMonth() === currentMonth && new Date(tx.date).getFullYear() === currentYear)
                .reduce((sum, tx) => sum + tx.amount, 0);
            
            const monthlyExpenses = transactions
                .filter(tx => tx.type === 'expense' && new Date(tx.date).getMonth() === currentMonth && new Date(tx.date).getFullYear() === currentYear)
                .reduce((sum, tx) => sum + Math.abs(tx.amount), 0);

            const monthlySavings = transactions
                .filter(tx => tx.type === 'saving' && new Date(tx.date).getMonth() === currentMonth && new Date(tx.date).getFullYear() === currentYear)
                .reduce((sum, tx) => sum + Math.abs(tx.amount), 0);
            
            const potentialInvestment = monthlyIncome - monthlyExpenses - monthlySavings;

            let recommendationHTML = '';
            if (potentialInvestment <= 0) {
                recommendationHTML = `
                    <div class="bg-card p-6 rounded-2xl text-center">
                        <h3 class="text-xl font-bold">Focus on Budgeting First!</h3>
                        <p class="text-gray-500 mt-2">It looks like you don't have extra cash this month. Let's work on your budget to free up some funds for investing!</p>
                    </div>
                `;
            } else {
                 let platformSuggestion = '';
                 if (potentialInvestment < 100) {
                     platformSuggestion = `
                        <h4 class="font-bold text-lg mt-4">Where to Start?</h4>
                        <p class="text-gray-600">With this amount, you can start small! Try micro-investing apps that let you invest with very little money.</p>
                        <p class="font-semibold mt-2">Platforms to check out: <strong>Raiz, Bibit (Mutual Funds)</strong></p>
                     `;
                 } else if (potentialInvestment >= 100 && potentialInvestment < 500) {
                      platformSuggestion = `
                        <h4 class="font-bold text-lg mt-4">Where to Start?</h4>
                        <p class="text-gray-600">You have a solid amount to begin! Robo-advisors are a great, hands-off way to get started in a diversified portfolio.</p>
                        <p class="font-semibold mt-2">Platforms to check out: <strong>StashAway, Wahed Invest</strong></p>
                     `;
                 } else {
                      platformSuggestion = `
                        <h4 class="font-bold text-lg mt-4">Where to Start?</h4>
                        <p class="text-gray-600">You're in a great position! You can explore robo-advisors for ease, or look into individual stocks or ETFs for more control.</p>
                        <p class="font-semibold mt-2">Platforms to check out: <strong>Interactive Brokers, GoTrade, Pluang</strong></p>
                     `;
                 }

                recommendationHTML = `
                    <div class="bg-card p-6 rounded-2xl text-center">
                         <p class="text-gray-500 text-sm">Based on your activity this month...</p>
                         <h3 class="text-lg font-bold">Your Potential Investment Amount is:</h3>
                         <p class="text-4xl font-extrabold text-primary my-2">${formatCurrency(potentialInvestment)}</p>
                         <p class="text-gray-500 text-xs">(Income - Expenses - Savings)</p>
                    </div>
                    <div class="bg-card p-6 rounded-2xl">
                        ${platformSuggestion}
                         <p class="text-xs text-gray-400 mt-4">Disclaimer: This is not financial advice. Platform availability may vary by country.</p>
                    </div>
                `;
            }
            contentDiv.innerHTML = recommendationHTML;
        }

        // --- DATA DEFENDER ---
        function analyzeLink() {
            const link = document.getElementById('link-input').value;
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = '';
            if (!link) { resultDiv.innerHTML = `<p class="text-yellow-500">Please enter a link.</p>`; return; }
            
            let findings = [];
            // Scam/Phishing Keywords
            ['login', 'verify', 'account', 'update', 'free', 'win', 'prize', 'lucky', 'hadiah', 'undian', 'klik', 'disini', 'secure', 'support'].forEach(k => {
                if (link.toLowerCase().includes(k)) findings.push({ type: 'warning', text: `Link contains a common scam keyword: "${k}".` });
            });
            // Data Theft Keywords
            ['.zip', '.exe', '.apk', '.rar', 'download', 'install', 'update-browser', 'security-alert'].forEach(k => {
                if (link.toLowerCase().includes(k)) findings.push({ type: 'danger', text: `Potential data theft risk: link contains "${k}".` });
            });
            // Online Gambling Keywords
            ['judi', 'slot', 'gacor', 'casino', 'poker', 'togel', 'bet', 'taruhan', 'maxwin', 'rtp'].forEach(k => {
                if (link.toLowerCase().includes(k)) findings.push({ type: 'danger', text: `Prohibited Content: Link related to online gambling.` });
            });
            // General checks
            if (!link.startsWith('https://')) { findings.push({ type: 'danger', text: 'Link does not use secure HTTPS.' }); } 
            ['bit.ly', 'tinyurl.com'].forEach(s => { if (link.includes(s)) { findings.push({ type: 'warning', text: `Uses a URL shortener which can hide the real destination.` }); } });

            let resultHTML = '<h4 class="font-bold text-lg mb-3">Analysis Report</h4>';
            const dangers = findings.filter(f => f.type === 'danger');
            const warnings = findings.filter(f => f.type === 'warning');

            if (dangers.length > 0) {
                resultHTML += `<div class="p-4 rounded-lg bg-red-100"><h5 class="font-bold text-red-600">üö® High Risk!</h5><p class="text-sm text-red-500">This link is in a prohibited category. Avoid opening it.</p></div>`;
            } else if (warnings.length > 0) {
                resultHTML += `<div class="p-4 rounded-lg bg-yellow-100"><h5 class="font-bold text-yellow-600">‚ö†Ô∏è Caution Advised</h5><p class="text-sm text-yellow-500">This link has suspicious characteristics. Proceed carefully.</p></div>`;
            } else {
                resultHTML += `<div class="p-4 rounded-lg bg-green-100"><h5 class="font-bold text-green-600">‚úÖ Low Risk</h5><p class="text-sm text-green-500">No major red flags found, but always stay vigilant.</p></div>`;
            }
            
            if (findings.length > 0) {
                resultHTML += '<ul class="space-y-2 mt-4 text-sm">';
                findings.forEach(f => {
                    let colorClass = f.type === 'danger' ? 'text-red-500' : 'text-yellow-500';
                    resultHTML += `<li class="${colorClass}"><strong>${f.type.charAt(0).toUpperCase() + f.type.slice(1)}:</strong> ${f.text}</li>`;
                });
                resultHTML += '</ul>';
            }
            resultDiv.innerHTML = resultHTML;
        }
        window.analyzeLink = analyzeLink;

        // --- INITIALIZATION ---
        function updateAll() {
            updateBalance();
            renderTransactions();
            renderBudgetPage();
            renderSavingGoals();
            updateInvestingPage();
            renderUserPoints();
            checkAndAwardPoints();
            renderRewardsPage();
        }

        window.onload = () => {
            checkLoginStatus();
        };
    </script>
</body>
</html>